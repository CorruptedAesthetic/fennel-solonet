# Fennel Protocol Deployment Guide

This guide covers deploying Fennel blockchain nodes both locally for development and to Azure Kubernetes Service (AKS) for production using GitOps.

## 🏗️ Architecture Overview

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   fennel-solonet │    │   fennel-prod    │    │   Kubernetes    │
│   (Source Code)  │───▶│   (GitOps)       │───▶│   (Runtime)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
      │                         │                        │
      ├─ Docker Images          ├─ HelmReleases          ├─ Pods
      ├─ Helm Charts           ├─ ConfigMaps            ├─ Services
      └─ Chain Specs           └─ Secrets               └─ Volumes
```

## 🚀 Quick Start - Local Development

### Prerequisites

- Docker installed and running
- WSL2 (if on Windows)
- At least 8GB RAM available
- 20GB free disk space

### 1. Local Development with k3d

Run the automated setup script:

```bash
cd fennel-solonet
./scripts/local-k3d-setup.sh setup
```

This script will:
- Install k3d, kubectl, and helm if needed
- Create a local Kubernetes cluster
- Build and deploy the Fennel node
- Set up all necessary secrets and configurations
- Provide access endpoints

### 2. Accessing Your Local Node

After setup completes, you can access:

- **RPC Endpoint**: `http://localhost:9944`
- **WebSocket**: `ws://localhost:9944`
- **P2P Port**: `30333`
- **Metrics**: `http://localhost:9615/metrics`

### 3. Testing Your Local Node

```bash
# Check node health
curl -H 'Content-Type: application/json' \
  -d '{"id":1, "jsonrpc":"2.0", "method": "system_health", "params":[]}' \
  http://localhost:9944

# Check node info
curl -H 'Content-Type: application/json' \
  -d '{"id":1, "jsonrpc":"2.0", "method": "system_name", "params":[]}' \
  http://localhost:9944

# View logs
kubectl logs -n fennel-local -l app.kubernetes.io/name=node -f
```

### 4. Local Development Commands

```bash
# Rebuild and redeploy
./scripts/local-k3d-setup.sh rebuild

# Clean up everything
./scripts/local-k3d-setup.sh cleanup

# View all pods
kubectl get pods -n fennel-local

# Port forward (if needed)
kubectl port-forward -n fennel-local svc/fennel-local-node 9944:9944
```

## ☁️ Production Deployment to Azure

### Prerequisites

- Azure account with AKS cluster
- Flux CD installed on AKS cluster
- `kubectl` configured for your AKS cluster
- Git access to your GitOps repository

### 1. Prepare Your AKS Cluster

```bash
# Install Flux on your AKS cluster
flux bootstrap github \
  --owner=<your-github-username> \
  --repository=fennel-prod \
  --branch=main \
  --path=./clusters/staging

# Verify Flux installation
flux get kustomizations
```

### 2. Configure Storage Classes

Update the storage class in your HelmRelease:

```yaml
# In fennel-prod/clusters/staging/helmrelease.yaml
node:
  node:
    chainData:
      storageClass: "managed-premium"  # Azure premium SSD
```

### 3. Create Staging Namespace and Secrets

```bash
# Create namespace
kubectl create namespace fennel-staging

# Create validator keys (use your actual keys for production)
kubectl create secret generic validator-keys \
  --namespace=fennel-staging \
  --from-literal=alice-gran="your-actual-gran-key" \
  --from-literal=alice-babe="your-actual-babe-key"

# Create node key
kubectl create secret generic node-key \
  --namespace=fennel-staging \
  --from-literal=node.key="your-actual-node-key"
```

### 4. Deploy to Staging

```bash
# Apply the staging configuration
kubectl apply -k fennel-prod/overlays/staging/

# Monitor deployment
kubectl get pods -n fennel-staging -w

# Check Flux reconciliation
flux get helmreleases -n fennel-staging
```

### 5. Verify Staging Deployment

```bash
# Check pod status
kubectl get pods -n fennel-staging

# View logs
kubectl logs -n fennel-staging -l app.kubernetes.io/name=node -f

# Check service endpoints
kubectl get services -n fennel-staging

# Access metrics (if exposed)
kubectl port-forward -n fennel-staging svc/fennel-staging-node 9615:9615
```

## 🔧 Configuration Management

### Image Tags

Images are automatically tagged by GitHub Actions with commit SHA:
- `ghcr.io/corruptedaesthetic/fennel-solonet:sha-<commit-hash>`

### Chain Specifications

Chain specs are generated by CI/CD and stored in:
- `chainspecs/development/development.json` - For local development
- `chainspecs/staging/staging-chainspec.json` - For staging environment

### Helm Chart Versions

The fennel-node Helm chart uses semantic versioning and is published to GitHub Pages.

## 🛠️ Troubleshooting

### Local Development Issues

**k3d cluster creation fails:**
```bash
# Clean up and retry
k3d cluster delete fennel-local
docker system prune -af
./scripts/local-k3d-setup.sh setup
```

**Image build fails:**
```bash
# Check Docker daemon
docker info

# Free up space
docker system prune -af

# Build manually
docker build -t fennel-node:local .
```

**Pod stuck in pending:**
```bash
# Check node resources
kubectl describe nodes

# Check PVC status
kubectl get pvc -n fennel-local
```

### Production Issues

**HelmRelease fails to install:**
```bash
# Check Flux status
flux get helmreleases -A

# Check Helm repository
flux get sources helm -A

# Debug HelmRelease
kubectl describe helmrelease fennel-staging -n fennel-staging
```

**Pod crashes on startup:**
```bash
# Check logs
kubectl logs -n fennel-staging <pod-name> --previous

# Check events
kubectl get events -n fennel-staging --sort-by='.lastTimestamp'

# Check chainspec ConfigMap
kubectl get configmap fennel-chainspec -n fennel-staging -o yaml
```

**Storage issues:**
```bash
# Check PVC status
kubectl get pvc -n fennel-staging

# Check storage class
kubectl get storageclass

# Describe PVC for events
kubectl describe pvc -n fennel-staging
```

## 🔐 Security Considerations

### Local Development
- Uses dummy keys and non-persistent storage
- All ports exposed for easy testing
- RPC methods include `unsafe` for development

### Staging Environment
- Uses persistent storage
- Real validator keys from Kubernetes secrets
- Internal load balancer for Azure
- Monitoring enabled

### Production Environment
- In-memory keystore mounting
- Backup and snapshot integration
- RBAC and network policies
- Enhanced security contexts

## 📊 Monitoring

### Prometheus Metrics

The node exposes metrics on port `9615`:
- Node health and sync status
- Block production metrics
- P2P networking stats
- Runtime performance data

### Useful Queries

```promql
# Block height
substrate_block_height{job="fennel-node"}

# Peer count
substrate_sub_libp2p_peers_count{job="fennel-node"}

# Import queue size
substrate_import_queue_blocks_submitted{job="fennel-node"}
```

## 🚢 CI/CD Pipeline

### GitHub Actions Workflow

The CI/CD pipeline:
1. Builds deterministic runtime with srtool
2. Generates development and staging chainspecs
3. Builds and publishes Docker image
4. Packages and publishes Helm chart
5. Updates GitOps repository (manual step)

### Updating Production

To deploy a new version:

1. **Automatic**: Push to main branch triggers CI/CD
2. **Update GitOps**: Manually update image tag in `fennel-prod/clusters/staging/helmrelease.yaml`
3. **Deploy**: Flux automatically detects and applies changes

## 🆘 Support

### Common Commands

```bash
# Check cluster status
kubectl cluster-info

# View all resources in namespace
kubectl get all -n fennel-staging

# Debug pod
kubectl describe pod <pod-name> -n fennel-staging

# Execute command in pod
kubectl exec -it <pod-name> -n fennel-staging -- /bin/bash

# View Flux logs
flux logs --level=debug
```

### Getting Help

1. Check the [troubleshooting section](#troubleshooting)
2. View pod logs and events
3. Check Flux reconciliation status
4. Consult Kubernetes documentation
5. Open an issue in the repository

## 📚 Additional Resources

- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [Flux CD Documentation](https://fluxcd.io/docs/)
- [Helm Documentation](https://helm.sh/docs/)
- [Polkadot SDK Documentation](https://paritytech.github.io/polkadot-sdk/)
- [Substrate Documentation](https://docs.substrate.io/)

## 🔄 Development Workflow

### Making Changes

1. **Local Development**:
   ```bash
   # Make code changes
   vim pallets/your-pallet/src/lib.rs
   
   # Test locally
   ./scripts/local-k3d-setup.sh rebuild
   ```

2. **Testing**:
   ```bash
   # Run tests
   cargo test --features=runtime-benchmarks
   
   # Test Docker build
   docker build -t fennel-node:test .
   ```

3. **Deployment**:
   ```bash
   # Push to trigger CI/CD
   git push origin main
   
   # Update GitOps (after CI/CD completes)
   # Edit fennel-prod/clusters/staging/helmrelease.yaml
   # Update image tag to new SHA
   ```

### Environment Progression

```
Local Development → Staging → Production
     (k3d)          (AKS)      (AKS)
```

Each environment has its own:
- Chain specification
- Resource allocation
- Security configuration
- Monitoring setup 